
library(GetoptLong)
library(bsub)

#### run cola analysis
for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	bsub_opt$output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/")
	bsub_script("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/script/test_cohort/test_GDS.R", .id = id,
		name = qq("cola_@{id}"), hour = 60, memory = 20, core = 4, enforce = FALSE)
}

for(pid in grep("^(DRP|ERP|GTE|SRP|TCGA)", dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/"), value = TRUE)) {
	bsub_opt$output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/")
	bsub_script("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/script/test_cohort/test_recount.R", .pid = pid,
		name = qq("cola_recount_@{pid}"), hour = 60, memory = 20, core = 4, enforce = FALSE)
}



###### only rerun report
library(GetoptLong)
library(bsub)

bsub_opt$packages = c("cola", "GetoptLong")

for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}"))$isdir) next
	
	bsub_opt$output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}")
	bsub_chunk(name = qq("GDS_@{id}_report"), hour = 20, mem = 10, core = 4, variables = "id", {

		res_list = readRDS(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/@{id}_cola_all.rds"))
		cola_report(res_list, output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/@{id}_cola_report"), 
			title = qq("cola Report for @{id}"), mc.cores = 4)

	})
}

for(pid in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}"))$isdir) next
	
	bsub_opt$output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}")
	bsub_chunk(name = qq("recount_@{pid}_report"), hour = 20, mem = 10, core = 4, variables = "pid", {

		res_list = readRDS(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/@{pid}_cola_all.rds"))
		cola_report(res_list, output_dir = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/@{pid}_cola_report"), 
			title = qq("cola Report for recount2:@{pid}"), mc.cores = 4)
	})
}


###### validate whether all jobs are generated by cola_1.3.2
for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	rmd = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/@{id}_cola_report/cola_report.md")
	ln = readLines(rmd)
	if(!any(grepl("cola_1\\.3\\.2", ln))) {
		qqcat("@{id} was not generated by cola 1.3.2\n")
	}
	if(!any(grepl(id, ln))) {
		qqcat("The report was not generated for @{id}\n")
	}
}
for(pid in grep("^(DRP|ERP|GTE|SRP|TCGA)", dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/"), value = TRUE)) {
	rmd = qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/@{pid}_cola_report/cola_report.md")
	ln = readLines(rmd)
	if(!any(grepl("cola_1\\.3\\.2", ln))) {
		qqcat("@{pid} was not generated by cola 1.3.2\n")
	}
	if(!any(grepl(pid, ln))) {
		qqcat("The report was not generated for @{pid}\n")
	}
}

############## host on github ################
library(GetoptLong)

### create repos

password = readline()

for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}"))$isdir) next
	
	# -XDELETE for delete repos
	cmd = qq("curl -u 'cola-GDS:@{password}' https://api.github.com/user/repos -d \"{\\\"name\\\":\\\"@{id}\\\"}\"")
	qqcat("creating repo for @{id}\n")
	system(cmd)
}

for(pid in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}"))$isdir) next
	
	cmd = qq("curl -u 'cola-recount2:@{password}' https://api.github.com/user/repos -d \"{\\\"name\\\":\\\"@{pid}\\\"}\"")
	qqcat("creating repo for @{pid}\n")
	system(cmd)
}

##### push
for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}"))$isdir) next
	
	qqcat("------------ upload report for @{id} -------------\n")

	setwd(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/@{id}_cola_report"))
	if(!file.exists(".git")) {
		system("git init")
		system(qq("echo '[cola report for @{id}](https://cola-gds.github.io/@{id}/cola_report.html)' > README.md"))
		system("git add README.md")
		system("git commit -m 'add readme'")
		system("git branch gh-pages")
	}
	if(!file.exists(qq("@{id}_cola_all.rds"))) {
		system(qq("cp ../@{id}_cola_all.rds @{id}_cola_all.rds"))
	}

	system("git add --all")
	system(qq("git commit -m 'commit the cola report for @{id}'"))
	system(qq("git push https://cola-GDS:@{password}@github.com/cola-GDS/@{id}.git master"))
	system("git checkout gh-pages")
	system("git merge master")
	system(qq("git push https://cola-GDS:@{password}@github.com/cola-GDS/@{id}.git gh-pages"))
	system("git checkout master")
}


### check file size, github requires single file size < 100MB
for(pid in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}"))$isdir) next
	
	setwd(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}"))
	f = qq("@{pid}_cola_all.rds")
	if(file.size(f) > 1000*1000*100) {  # 1024*1024*100
		qqcat("------------ compress @{f} -------------\n")
		res = readRDS(f)
		saveRDS(res, file = f, compress = "xz")
	}
}

for(pid in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/")) {
	if(!file.info(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}"))$isdir) next
	qqcat("------------ upload report for @{pid} -------------\n")

	setwd(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/@{pid}_cola_report"))
	if(!file.exists(".git")) {
		system("git init")
		system(qq("echo '[cola report for @{pid}](https://cola-recount2.github.io/@{pid}/cola_report.html)' > README.md"))
		system("git add README.md")
		system("git commit -m 'add readme'")
		system("git branch gh-pages")
	}
	if(!file.exists(qq("@{pid}_cola_all.rds"))) {
		system(qq("cp ../@{pid}_cola_all.rds @{pid}_cola_all.rds"))
	}

	system("git add --all")
	system(qq("git commit -m 'commit the cola report for @{pid}'"))
	system(qq("git push https://cola-recount2:@{password}@github.com/cola-recount2/@{pid}.git master"))
	system("git checkout gh-pages")
	system("git merge master")
	system(qq("git push https://cola-recount2:@{password}@github.com/cola-recount2/@{pid}.git gh-pages"))
	system("git checkout master")
}

########## check whether the uploading is successful
for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	oe = try(ln <- scan(qq("https://cola-gds.github.io/@{id}/cola_report.md"), what = "character", quiet = TRUE), silent = TRUE)
	if(inherits(oe, "try-error")) {
		qqcat("@{id} was not generated\n")
		next
	}
	if(!any(grepl("cola_1\\.3\\.2", ln))) {
		qqcat("@{id} was not generated\n")
	}
	if(!any(grepl(id, ln))) {
		qqcat("The report was not generated for @{id}\n")
	}
}
for(pid in grep("^(DRP|ERP|GTE|SRP|TCGA)", dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/"), value = TRUE)) {
	oe = try(ln <- scan(qq("https://cola-recount2.github.io/@{pid}/cola_report.md"), what = "character", quiet = TRUE), silent = TRUE)
	if(inherits(oe, "try-error")) {
		qqcat("@{pid} was not generated\n")
		next
	}
	if(!any(grepl("cola_1\\.3\\.2", ln))) {
		qqcat("@{pid} was not generated\n")
	}
	if(!any(grepl(pid, ln))) {
		qqcat("The report was not generated for @{pid}\n")
	}
}

####  check whether the rds files are uploaded
for(id in dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")) {
	ln <- readLines(pipe(qq("curl --head --progress-bar https://cola-gds.github.io/@{id}/@{id}_cola_all.rds")))
	if(any(grepl("404 Not Found", ln))) {
		qqcat("@{id} was not generated\n")
	}
}
for(pid in grep("^(DRP|ERP|GTE|SRP|TCGA)", dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/"), value = TRUE)) {
	ln <- readLines(pipe(qq("curl --head --progress-bar https://cola-recount2.github.io/@{pid}/@{pid}_cola_all.rds")))
	if(any(grepl("404 Not Found", ln))) {
		qqcat("@{pid} was not generated\n")
	}
}

### generate the readme which contains links for all datasets
#### get a general information of all datasets
## GDS
library(GEOquery)

all_id = dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/", pattern = "GDS\\d+")
title = NULL
n_samples = NULL
n_features = NULL
rds = NULL
for(id in all_id) {
	gds = readRDS(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/GDS/@{id}/@{id}.rds"))
	title = c(title, gds@header$title)
	n_samples = c(n_samples, ncol(gds@dataTable@table) - 2)
	n_features = c(n_features, nrow(gds@dataTable@table))
	rds = c(rds, qq("<a href='https://cola-gds.github.io/@{id}/@{id}_cola_all.rds'>rds file</a>"))
}

all_id2 = qq("<a href='https://www.ncbi.nlm.nih.gov/sites/GDSbrowser?acc=@{all_id}'>@{all_id}</a>", collapse = FALSE)
title2 = qq("<a href='https://cola-gds.github.io/@{all_id}/cola_report.html'>@{title}</a>", collapse = FALSE)

writeLines(kable(cbind(ID = all_id2, title = title2, n_samples = n_samples, n_features = n_features, rds = rds),
	col.names = c("ID", "Title", "Samples", "Features", "RDS file")),
	con = "/desktop-home/guz/test.md")


## recount2
all_id = grep("^(DRP|ERP|GTE|SRP|TCGA)", dir("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/"), value = TRUE)

l = grepl("^(DRP|ERP|SRP)", all_id)
all_id2 = all_id
all_id2[l] = qq("<a href='http://trace.ncbi.nlm.nih.gov/Traces/sra/?study=@{all_id[l]}'>@{all_id[l]}</a>", collapse = FALSE)
# title2 = qq("<a href='https://cola-recount2.github.io/@{all_id}/cola_report.html'>cola report</a>", collapse = FALSE)


library(xml2)
get_title_by_study = function(study) {
	x = read_xml(qq("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=sra&term=@{study}"))
	id = xml_text(xml_find_all(x, ".//Id")[[1]])
	x2 = read_xml(qq("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=sra&id=@{id}"))
	title = xml_text(xml_find_all(x2, ".//.//STUDY_TITLE")[[1]])
	title = gsub("\\.\\s*$", "", title)
	title
}

library(SummarizedExperiment)
n_samples = NULL
n_features = NULL
rds = NULL
title = NULL
for(pid in all_id) {
	load(qq("/icgc/dkfzlsdf/analysis/B080/guz/cola_test/recount2/@{pid}/@{pid}_rse_gene.Rdata"))
	n_samples = c(n_samples, dim(rse_gene)[2])
	n_features = c(n_features, dim(rse_gene)[1])
	rds = c(rds, qq("<a href='https://cola-recount2.github.io/@{pid}/@{pid}_cola_all.rds'>rds_file</a>"))

	if(grepl("^DRP|ERP|SRP", pid)) {
		t = get_title_by_study(pid)
	} else {
		t = pid
	}
	title = c(title, t)
}

title = gsub("_", " ", title)
title2 = qq("<a href='https://cola-recount2.github.io/@{all_id}/cola_report.html'>@{title}</a>", collapse = FALSE)

writeLines(kable(cbind(ID = all_id2, title = title2, n_samples = n_samples, n_features = n_features, rds = rds),
	col.names = c("ID", "Title", "Samples", "Features", "File")), con = "/desktop-home/guz/test.md")
